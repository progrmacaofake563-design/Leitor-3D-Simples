<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor 3D: Estante Híbrida</title>
    
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <style>
        :root {
            --bg-c1: #232526; --bg-c2: #414345; --bg-c3: #121212;
            --book-w: 300px; --book-h: 440px; --depth: 50px;
            --default-cover: #3a3a3a; --spine-color: #2b2b2b;   
        }

        body {
            margin: 0;
            background-image: linear-gradient(135deg, var(--bg-c1), var(--bg-c2), var(--bg-c3), var(--bg-c1));
            background-size: 300% 300%;
            animation: gradientMove 20s ease infinite;
            height: 100vh; display: flex; justify-content: center; align-items: center;
            overflow: hidden; font-family: 'Segoe UI', sans-serif; perspective: 3500px; user-select: none;
            transition: --bg-c1 5s, --bg-c2 5s, --bg-c3 5s; 
        }

        @property --bg-c1 { syntax: '<color>'; inherits: false; initial-value: #232526; }
        @property --bg-c2 { syntax: '<color>'; inherits: false; initial-value: #414345; }
        @property --bg-c3 { syntax: '<color>'; inherits: false; initial-value: #121212; }

        @keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* --- BOTÃO SURPRESA (Menu Esquerdo) --- */
        .magic-menu {
            position: fixed; top: 30px; left: 30px; z-index: 200;
        }
        .btn-surprise {
            background: rgba(255,255,255,0.05); backdrop-filter: blur(5px); color: rgba(255,255,255,0.7);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 30px; padding: 10px 20px;
            cursor: pointer; display: flex; align-items: center; gap: 10px;
            font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
            transition: 0.3s;
        }
        .btn-surprise:hover { background: white; color: #121212; transform: translateX(5px); box-shadow: 0 0 20px rgba(255,255,255,0.3); }
        .btn-surprise.active { border-color: #F2C94C; color: #F2C94C; }

        /* --- LIXEIRA FANTASMA (Direita Superior) --- */
        .trash-zone {
            position: fixed; top: 0; right: 0;
            width: 120px; height: 120px; /* Área de detecção do mouse */
            z-index: 200; display: flex; justify-content: center; align-items: center;
            /* background: rgba(255,0,0,0.1);  Descomente para ver a área de teste */
        }
        
        .btn-trash-ghost {
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(255, 50, 50, 0.2); color: #ff6b6b; border: 1px solid rgba(255, 50, 50, 0.4);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            
            /* Estado Inicial: Invisível e pequeno */
            opacity: 0; transform: scale(0.5); pointer-events: none;
        }

        /* O Efeito Mágico: Aparece ao passar o mouse na ZONA */
        .trash-zone:hover .btn-trash-ghost {
            opacity: 1; transform: scale(1); pointer-events: all;
        }
        .btn-trash-ghost:hover { background: #ff4757; color: white; transform: scale(1.15) !important; box-shadow: 0 0 15px #ff4757; }


        /* --- OUTROS ELEMENTOS --- */
        .bottom-controls {
            position: fixed; bottom: 30px; width: 100%; display: flex; justify-content: center; align-items: center; gap: 20px;
            pointer-events: none; z-index: 100; opacity: 0; transform: translateY(20px); transition: 0.5s;
        }
        body.reading .bottom-controls { opacity: 1; transform: translateY(0); pointer-events: all; }

        .btn-ui {
            background: rgba(255,255,255,0.1); color: white; padding: 10px 20px; border-radius: 50px;
            cursor: pointer; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);
            font-weight: 600; text-transform: uppercase; font-size: 12px; transition: 0.3s; pointer-events: all;
            display: flex; align-items: center; gap: 8px;
        }
        .btn-ui:hover { background: white; color: black; transform: scale(1.05); }

        .click-zone { position: fixed; top: 0; height: 100%; width: 15%; z-index: 80; cursor: pointer; display: none; }
        .zone-left { left: 0; } .zone-right { right: 0; }
        body.reading .click-zone { display: block; }

        /* CENA 3D */
        .scene { position: relative; width: var(--book-w); height: var(--book-h); transform-style: preserve-3d; transition: transform 1.2s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .scene.closed { transform: rotateX(55deg) rotateZ(-30deg) translateZ(-50px); }
        .scene.open { transform: rotateX(0deg) rotateZ(0deg) translateZ(50px); }

        .book-model { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.1s ease-out, opacity 0.5s; cursor: pointer; }
        .book-model.disabled { pointer-events: none; cursor: wait; filter: grayscale(1); opacity: 0.8; }
        .scene.open .book-model { opacity: 0; pointer-events: none; }

        .layer-back { position: absolute; width: 100%; height: 100%; background-color: var(--default-cover); transform: translateZ(-2px); box-shadow: 25px 25px 50px rgba(0,0,0,0.5); border-radius: 3px; transition: background-color 0.5s; }
        .layer-spine { position: absolute; top: 0; left: 0; width: var(--depth); height: 100%; background-color: var(--spine-color); background-image: linear-gradient(to right, rgba(0,0,0,0.4), transparent 40%, rgba(0,0,0,0.2)); transform-origin: left; transform: rotateY(-90deg); border-radius: 3px 0 0 3px; transition: background-color 0.5s; }
        .layer-pages { position: absolute; right: 0; top: 3px; width: calc(var(--book-w) - 5px); height: calc(var(--book-h) - 6px); background: #fff; transform: translateZ(calc(var(--depth) / 2)); }
        .layer-pages::before { content: ''; position: absolute; top:0; left:100%; width:var(--depth); height:100%; background:#e0e0e0; transform-origin:left; transform:rotateY(90deg); background-image:repeating-linear-gradient(to right, #e0e0e0 0, #f5f5f5 1px, #e0e0e0 3px); }
        .layer-pages::after { content: ''; position: absolute; top:100%; left:0; width:100%; height:var(--depth); background:#e0e0e0; transform-origin:top; transform:rotateX(-90deg); background-image:repeating-linear-gradient(to bottom, #e0e0e0 0, #f5f5f5 1px, #e0e0e0 3px); }

        .layer-cover { position: absolute; width: 100%; height: 100%; background-color: var(--default-cover); background-size: cover; background-position: center; transform: translateZ(var(--depth)); border-radius: 3px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; border-left: 2px solid rgba(255,255,255,0.1); transition: background-image 0.5s; }
        .cover-text { transition: opacity 0.3s; }
        .layer-cover.has-image .cover-text { opacity: 0; }

        .loader { width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; animation: spin 1s infinite linear; margin: 20px auto; display: none; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .reader-stage { position: absolute; top:0; left:0; width: calc(var(--book-w) * 2); height: var(--book-h); transform: translateX(calc(var(--book-w) / -2)) scale(1); transform-origin: center center; opacity: 0; pointer-events: none; transition: opacity 0.5s 0.6s, transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .scene.open .reader-stage { opacity: 1; pointer-events: all; }

        .center-shadow { position: absolute; left: 50%; top: 0; width: 60px; height: 100%; transform: translateX(-50%); background: linear-gradient(to right, rgba(0,0,0,0) 0%, rgba(0,0,0,0.15) 40%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.15) 60%, rgba(0,0,0,0) 100%); z-index: 10; pointer-events: none; mix-blend-mode: multiply; }
        
        .page { background: #fdfdfd; border-right: 1px solid #eee; }
        .epub-container { padding: 40px; height: 100%; box-sizing: border-box; font-size: 15px; line-height: 1.6; color: #333; text-align: justify; overflow-y: auto; }
        .epub-container img { max-width: 100%; height: auto; }

        #file-input { display: none; }
        .status-msg { font-size: 11px; margin-top: 8px; opacity: 0.8; letter-spacing: 1px; color: #ccc; min-height: 15px; }
        
        .mood-indicator { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); font-size: 11px; text-transform: uppercase; letter-spacing: 3px; color: rgba(255,255,255,0.4); pointer-events: none; z-index: 50; transition: opacity 1s; opacity: 0; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        body.reading .mood-indicator { opacity: 1; }

        .zoom-container { background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); padding: 10px 20px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 15px; color: white; }
        input[type=range] { -webkit-appearance: none; width: 100px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: white; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body id="body">

    <div class="magic-menu">
        <div class="btn-surprise" id="btn-surprise" onclick="enableSurpriseMode()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><circle cx="12" cy="12" r="1.5" fill="currentColor"></circle><circle cx="7" cy="7" r="1.5" fill="currentColor"></circle><circle cx="17" cy="17" r="1.5" fill="currentColor"></circle></svg>
            <span>Livro Surpresa</span>
        </div>
    </div>

    <div class="trash-zone">
        <div class="btn-trash-ghost" id="btn-trash" onclick="trashBook()" title="Remover Livro">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
        </div>
    </div>

    <div class="click-zone zone-left" onclick="prevPage()" title="Anterior"></div>
    <div class="click-zone zone-right" onclick="nextPage()" title="Próxima"></div>

    <div class="mood-indicator" id="mood-text">Atmosfera</div>

    <div class="bottom-controls">
        <div class="btn-ui" onclick="closeBook()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
            Fechar
        </div>

        <div class="zoom-container">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
            <input type="range" id="zoom-slider" min="0.8" max="1.8" step="0.1" value="1" oninput="handleZoom(this.value)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
        </div>
        
        <div class="btn-ui" onclick="toggleAudio()" style="min-width: 40px; justify-content: center;">
            <svg id="icon-sound-on" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
            <svg id="icon-sound-off" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
        </div>

        <div class="zoom-container">
            <span class="page-counter" id="page-counter">-- / --</span>
        </div>
    </div>

    <input type="file" id="file-input" accept=".pdf,.epub">

    <div class="scene closed" id="scene">
        <div class="book-model" id="book-model" onclick="handleInteraction()">
            <div class="layer-back"></div>
            <div class="layer-spine"></div>
            <div class="layer-pages"></div>
            <div class="layer-cover" id="front-cover">
                <div class="layer-cover-overlay" style="position:absolute; width:100%; height:100%; background: linear-gradient(135deg, transparent 30%, rgba(255,255,255,0.2) 50%, transparent 70%); pointer-events:none;"></div>
                <div class="cover-text">
                    <h1 style="margin:0; font-size:2.5rem; letter-spacing: 2px;">LIVRO</h1>
                    <p style="opacity:0.7; margin-top: 10px;" id="cover-subtitle">Clique para Adicionar</p>
                    <div class="loader" id="loader"></div>
                    <div class="status-msg" id="status-msg"></div>
                </div>
            </div>
        </div>
        <div id="reader-anchor"></div> 
    </div>

    <script>
        // CONFIGURAÇÃO
        const GH_BASE = "https://raw.githubusercontent.com/progrmacaofake563-design/Leitor-3D-Simples/main/livros/";
        const myBooks = [ "alice.epub", "arte-da-guerra.epub", "dom-carmurro.epub", "dracula.epub", "frankenstein.epub", "iracema.epub", "memorias-postumas.epub", "metamorfose.epub", "o-cortico.epub" ];

        // ELEMENTOS
        const scene = document.getElementById('scene');
        const bookModel = document.getElementById('book-model');
        const fileInput = document.getElementById('file-input');
        const loader = document.getElementById('loader');
        const frontCover = document.getElementById('front-cover');
        const readerAnchor = document.getElementById('reader-anchor');
        const body = document.getElementById('body');
        const statusMsg = document.getElementById('status-msg');
        const zoomSlider = document.getElementById('zoom-slider');
        const pageCounter = document.getElementById('page-counter');
        const moodText = document.getElementById('mood-text');
        const btnSurprise = document.getElementById('btn-surprise');

        // ESTADO
        let pageFlip = null;
        let isBookLoaded = false;
        let isReading = false;
        let currentReaderStage = null;
        let isAudioEnabled = true;
        let coverPalette = { c1: '#232526', c2: '#414345', c3: '#121212' };
        
        let autoSwapTimer = null;
        let surpriseModeActive = false;

        // INICIALIZAÇÃO
        window.addEventListener('load', () => {
            // Não carrega nada automaticamente. Espera o usuário.
        });

        // --- MODO SURPRESA ---
        function enableSurpriseMode() {
            surpriseModeActive = true;
            btnSurprise.classList.add('active');
            
            // Se o usuário estiver lendo algo, fecha.
            if (isReading) closeBook();
            
            // Carrega o primeiro livro aleatório
            loadRandomBook();
            
            // Inicia o timer
            startAutoSwapTimer();
        }

        function startAutoSwapTimer() {
            if (autoSwapTimer) clearInterval(autoSwapTimer);
            if (!surpriseModeActive) return;

            // Timer de 5 minutos (300.000ms)
            autoSwapTimer = setInterval(() => {
                // Só troca se o livro estiver na estante (fechado)
                if (!isReading && isBookLoaded) {
                    console.log("Timer Surpresa: Trocando livro...");
                    loadRandomBook();
                }
            }, 300000); 
        }

        async function loadRandomBook() {
            if (bookModel.classList.contains('disabled')) return;
            loader.style.display = 'block'; bookModel.classList.add('disabled');
            statusMsg.innerText = "Sorteando leitura...";

            try {
                await hardReset();
                const randomFile = myBooks[Math.floor(Math.random() * myBooks.length)];
                const url = GH_BASE + randomFile;
                statusMsg.innerText = `Baixando: ${randomFile.replace('.epub', '')}...`;

                const response = await fetch(url);
                if (!response.ok) throw new Error("Erro GitHub");
                const blob = await response.blob();
                const file = new File([blob], randomFile, { type: "application/epub+zip" });

                await processFileLoad(file);
                
                // Feedback visual na estante
                bookModel.style.transform = "scale(1.05) rotateY(10deg)";
                setTimeout(() => bookModel.style.transform = "", 400);

            } catch (err) {
                console.error(err); statusMsg.innerText = "Erro na conexão.";
            } finally {
                loader.style.display = 'none'; bookModel.classList.remove('disabled');
            }
        }

        // --- INTERAÇÃO PRINCIPAL (ARQUIVO LOCAL) ---
        function handleInteraction() {
            if (bookModel.classList.contains('disabled')) return;
            
            if (isBookLoaded) {
                openBook();
            } else {
                // Se não tem livro, abre a seleção de arquivo
                fileInput.click();
            }
        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            // Se o usuário escolheu um arquivo manual, desligamos o modo surpresa
            surpriseModeActive = false;
            btnSurprise.classList.remove('active');
            if (autoSwapTimer) clearInterval(autoSwapTimer);

            loader.style.display = 'block'; bookModel.classList.add('disabled');
            try {
                await hardReset();
                await processFileLoad(file);
            } catch(e) { alert("Erro arquivo"); trashBook(); }
            finally { loader.style.display = 'none'; bookModel.classList.remove('disabled'); fileInput.value=''; }
        });

        async function processFileLoad(file) {
            await generateCoverAndColor(file);
            createFreshStage();
            if(file.type === 'application/pdf') await loadPDF(file);
            else await loadEPUB(file);
            
            isBookLoaded = true;
            statusMsg.innerText = "";
            document.getElementById('cover-subtitle').innerText = "Clique para Abrir";
        }

        // --- REMOVER LIVRO (LIXEIRA) ---
        function trashBook() {
            if (isReading) closeBook();
            
            // Espera a animação de fechar e reseta
            setTimeout(() => {
                hardReset();
                surpriseModeActive = false;
                btnSurprise.classList.remove('active');
                if (autoSwapTimer) clearInterval(autoSwapTimer);
                
                document.getElementById('cover-subtitle').innerText = "Clique para Adicionar";
                bookModel.style.transform = "rotateY(360deg)"; // Efeito de reset
                setTimeout(() => bookModel.style.transform = "", 500);
            }, 600);
        }

        async function hardReset() {
            if (pageFlip) { pageFlip.destroy(); pageFlip = null; }
            if (currentReaderStage) { currentReaderStage.remove(); currentReaderStage = null; }
            
            frontCover.style.backgroundImage = 'none'; frontCover.classList.remove('has-image');
            coverPalette = { c1: '#232526', c2: '#414345', c3: '#121212' };
            setAmbientColor('neutral');
            isBookLoaded = false; zoomSlider.value = 1; statusMsg.innerText = "";
        }

        // --- LEITURA & UI ---
        function openBook() {
            isReading = true;
            bookModel.style.transform = 'rotateX(0deg) rotateY(0deg)';
            scene.classList.remove('closed'); scene.classList.add('open');
            body.classList.add('reading');
            flipAudio.play().then(()=>flipAudio.pause()).catch(()=>{});
            setTimeout(() => { if (!pageFlip) initFlip(); }, 600);
        }

        function closeBook() {
            isReading = false;
            scene.classList.remove('open'); scene.classList.add('closed');
            body.classList.remove('reading');
            setTimeout(() => { zoomSlider.value = 1; handleZoom(1); setAmbientColor('neutral'); }, 500);
            
            // Se modo surpresa estiver ativo, reinicia timer ao fechar
            if (surpriseModeActive) startAutoSwapTimer();
        }

        function createFreshStage() {
            const div = document.createElement('div'); div.className = 'reader-stage';
            const shadow = document.createElement('div'); shadow.className = 'center-shadow';
            div.appendChild(shadow); readerAnchor.appendChild(div); currentReaderStage = div;
        }

        function initFlip() {
            if(!currentReaderStage) return;
            const pages = currentReaderStage.querySelectorAll('.page');
            pageFlip = new St.PageFlip(currentReaderStage, { width: 300, height: 440, size: 'fixed', minWidth: 300, maxWidth: 300, minHeight: 440, maxHeight: 440, showCover: false, usePortrait: false, maxShadowOpacity: 0.5, autoSize: true, flippingTime: 800 });
            pageFlip.loadFromHTML(pages);
            pageFlip.on('flip', () => { playFlipSound(); updatePageData(); });
            updatePageData();
        }

        // --- MOTORES (PDF/EPUB) ---
        async function loadEPUB(file) {
            const buf = await file.arrayBuffer(); const book = ePub(buf); await book.ready;
            const spine = book.spine; let count = 0;
            for(const item of spine.items){
                if(count > 50) break; 
                try {
                    const section = await book.load(item.href);
                    let contentHTML = (section instanceof Document) ? section.body.innerHTML : `<p>${section.innerText || ""}</p>`;
                    if (section instanceof DocumentFragment) { const div = document.createElement('div'); div.appendChild(section.cloneNode(true)); contentHTML = div.innerHTML; }
                    const d = document.createElement('div'); d.className = 'page'; d.innerHTML = `<div class="epub-container">${contentHTML}</div>`;
                    d.querySelectorAll('img').forEach(img => { img.style.maxWidth = '100%'; img.style.height = 'auto'; img.onerror = function(){this.style.display='none';} });
                    currentReaderStage.appendChild(d); count++;
                } catch(e){}
            }
        }

        async function loadPDF(file) {
            const buf = await file.arrayBuffer(); const pdf = await pdfjsLib.getDocument(buf).promise;
            const maxPages = Math.min(pdf.numPages, 40); 
            for(let i=1; i<=maxPages; i++){
                const p = await pdf.getPage(i);
                let txt = ""; try { txt = (await p.getTextContent()).items.slice(0,40).map(s=>s.str).join(' '); } catch(e){}
                const vp = p.getViewport({scale: (440/p.getViewport({scale:1}).height)*2});
                const d = document.createElement('div'); d.className = 'page'; d.setAttribute('data-text', txt);
                d.innerHTML = `<div class="page-content"><canvas></canvas></div>`;
                const canvas = d.querySelector('canvas'); canvas.width = vp.width; canvas.height = vp.height;
                await p.render({canvasContext: canvas.getContext('2d'), viewport: vp}).promise;
                currentReaderStage.appendChild(d); 
            }
        }

        // --- UTILS (Capa/Cor/Som/Emoção) ---
        async function generateCoverAndColor(file) {
            let coverUrl = null;
            try {
                if (file.type === 'application/pdf') {
                    const buf = await file.arrayBuffer(); const pdf = await pdfjsLib.getDocument(buf).promise;
                    const page = await pdf.getPage(1); const vp = page.getViewport({ scale: 1 });
                    const cvs = document.createElement('canvas'); cvs.width = vp.width; cvs.height = vp.height;
                    await page.render({ canvasContext: cvs.getContext('2d'), viewport: vp }).promise; coverUrl = cvs.toDataURL();
                } else {
                    const buf = await file.arrayBuffer(); const book = ePub(buf); coverUrl = await book.coverUrl();
                }
                if (coverUrl) { frontCover.style.backgroundImage = `url(${coverUrl})`; frontCover.classList.add('has-image'); extractPalette(coverUrl); }
            } catch(e) {}
        }

        function extractPalette(src) {
            const img = new Image(); img.src = src; img.crossOrigin = "Anonymous";
            img.onload = () => {
                const c = document.createElement('canvas'); c.width=50; c.height=50; 
                const ctx = c.getContext('2d'); ctx.drawImage(img,0,0,50,50);
                const data = ctx.getImageData(0,0,50,25).data;
                let r=0,g=0,b=0,n=0; for(let i=0;i<data.length;i+=4){ r+=data[i];g+=data[i+1];b+=data[i+2];n++; }
                r=Math.floor(r/n); g=Math.floor(g/n); b=Math.floor(b/n);
                coverPalette = { c1: `rgb(${r},${g},${b})`, c2: `rgb(${r*0.8},${g*0.8},${b*0.8})`, c3: `rgb(${r*0.5},${g*0.5},${b*0.5})` };
                document.documentElement.style.setProperty('--default-cover', coverPalette.c1);
                document.documentElement.style.setProperty('--spine-color', coverPalette.c2);
                setAmbientColor('neutral');
            }
        }

        const flipAudio = new Audio("https://www.soundjay.com/office/sounds/paper-flip-1.mp3"); flipAudio.volume=0.5;
        function toggleAudio() { isAudioEnabled = !isAudioEnabled; document.getElementById('icon-sound-on').style.display=isAudioEnabled?'block':'none'; document.getElementById('icon-sound-off').style.display=isAudioEnabled?'none':'block'; }
        function playFlipSound() { if(isAudioEnabled) { flipAudio.currentTime=0; flipAudio.play().catch(()=>{}); } }

        function prevPage() { if(pageFlip) pageFlip.flipPrev(); }
        function nextPage() { if(pageFlip) pageFlip.flipNext(); }
        function handleZoom(val) { if(currentReaderStage) currentReaderStage.style.transform=`translateX(-150px) scale(${val})`; }

        const emotionMap = {
            sad: { keywords: ['triste','morte','dor','solidão','luto','fim','melancolia'], colors: ['#1e3c72', '#2a5298', '#141E30'] },
            happy: { keywords: ['feliz','alegria','sol','amor','luz','risada','vida'], colors: ['#F2994A', '#F2C94C', '#ffedbc'] },
            anger: { keywords: ['raiva','ódio','grito','fogo','sangue','fúria','guerra'], colors: ['#cb2d3e', '#ef473a', '#560a0a'] },
            fear: { keywords: ['medo','sombra','noite','terror','pânico','monstro','escuridão'], colors: ['#232526', '#414345', '#0f0c29'] },
            calm: { keywords: ['paz','rio','floresta','verde','vento','calma','silêncio'], colors: ['#134E5E', '#71B280', '#2d5a3f'] },
            love: { keywords: ['amor','beijo','paixão','coração','romance','doce','te amo'], colors: ['#aa076b', '#61045f', '#ff9a9e'] }
        };

        function setAmbientColor(type) {
            let palette = (type === 'neutral') ? [coverPalette.c1, coverPalette.c2, coverPalette.c3] : (emotionMap[type] ? emotionMap[type].colors : null);
            if(!palette) return;
            document.documentElement.style.setProperty('--bg-c1', palette[0]);
            document.documentElement.style.setProperty('--bg-c2', palette[1]);
            document.documentElement.style.setProperty('--bg-c3', palette[2]);
            moodText.innerText = (type==='neutral') ? "Original do Livro" : type.toUpperCase();
            moodText.style.color = palette[1];
        }

        function updatePageData() {
            if(!pageFlip) return;
            pageCounter.innerText = `${pageFlip.getCurrentPageIndex() + 1} / ${pageFlip.getPageCount()}`;
            try {
                const els = currentReaderStage.querySelectorAll('.page');
                let txt = (els[pageFlip.getCurrentPageIndex()]?.innerText || "") + " " + (els[pageFlip.getCurrentPageIndex()+1]?.innerText || "");
                if(txt.length > 10) {
                    const clean = txt.toLowerCase().substring(0,500);
                    for(const [emo, data] of Object.entries(emotionMap)) {
                        if(data.keywords.some(k => clean.includes(k))) { setAmbientColor(emo); return; }
                    }
                    setAmbientColor('neutral');
                }
            } catch(e){}
        }

        document.addEventListener('mousemove', (e) => {
            if (isReading) return;
            const x = (e.clientX / window.innerWidth) * 2 - 1;
            const y = (e.clientY / window.innerHeight) * 2 - 1;
            bookModel.style.transform = `rotateX(${y * -15}deg) rotateY(${x * 20}deg)`;
        });

        window.addEventListener('keydown', (e) => {
            if(!isReading || !pageFlip) return;
            if(e.key==="ArrowRight") nextPage();
            if(e.key==="ArrowLeft") prevPage();
            if(e.key==="Escape") closeBook();
        });

    </script>
</body>
</html>
