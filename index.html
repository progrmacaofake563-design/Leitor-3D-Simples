<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor Imersivo: Áudio & Cliques</title>
    
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <style>
        :root {
            --bg-c1: #232526;
            --bg-c2: #414345;
            --bg-c3: #121212;
            
            --book-w: 300px;
            --book-h: 440px;
            --depth: 50px;
            
            --default-cover: #3a3a3a; 
            --spine-color: #2b2b2b;   
        }

        body {
            margin: 0;
            background-image: linear-gradient(135deg, var(--bg-c1), var(--bg-c2), var(--bg-c3), var(--bg-c1));
            background-size: 300% 300%;
            animation: gradientMove 20s ease infinite;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
            perspective: 3500px;
            user-select: none;
            transition: --bg-c1 5s, --bg-c2 5s, --bg-c3 5s; 
        }

        /* Registro de variáveis para transição suave (Chrome/Edge/Novos Safari) */
        @property --bg-c1 { syntax: '<color>'; inherits: false; initial-value: #232526; }
        @property --bg-c2 { syntax: '<color>'; inherits: false; initial-value: #414345; }
        @property --bg-c3 { syntax: '<color>'; inherits: false; initial-value: #121212; }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- ZONAS DE CLIQUE (NOVIDADE) --- */
        .click-zone {
            position: fixed; top: 0; height: 100%; width: 20%;
            z-index: 80; cursor: pointer;
            display: none; /* Só aparecem ao ler */
            transition: background 0.3s;
        }
        .click-zone:hover { background: rgba(255,255,255,0.02); }
        
        .zone-left { left: 0; }
        .zone-right { right: 0; }
        
        /* Indicador visual ao passar o mouse nas laterais */
        .zone-left::after, .zone-right::after {
            content: ''; position: absolute; top: 50%; 
            width: 20px; height: 20px; border-top: 2px solid rgba(255,255,255,0.3); border-left: 2px solid rgba(255,255,255,0.3);
            opacity: 0; transition: 0.3s; transform: translateY(-50%) rotate(-45deg);
        }
        .zone-left::after { left: 20px; }
        .zone-right::after { right: 20px; transform: translateY(-50%) rotate(135deg); }
        
        .click-zone:hover::after { opacity: 1; }

        body.reading .click-zone { display: block; }

        /* --- UI Elements --- */
        .mood-indicator {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
            font-size: 11px; text-transform: uppercase; letter-spacing: 3px;
            color: rgba(255,255,255,0.4); pointer-events: none; z-index: 50;
            transition: opacity 1s; opacity: 0; text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        body.reading .mood-indicator { opacity: 1; }

        .top-controls {
            position: fixed; top: 30px; width: 100%; padding: 0 40px; box-sizing: border-box;
            display: flex; justify-content: space-between; pointer-events: none; z-index: 100;
        }

        .bottom-controls {
            position: fixed; bottom: 30px; width: 100%; display: flex; justify-content: center; align-items: center; gap: 20px;
            pointer-events: none; z-index: 100; opacity: 0; transform: translateY(20px); transition: 0.5s;
        }
        body.reading .bottom-controls { opacity: 1; transform: translateY(0); pointer-events: all; }

        .btn-ui {
            background: rgba(255,255,255,0.1); color: white; padding: 10px 20px; border-radius: 50px;
            cursor: pointer; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);
            font-weight: 600; text-transform: uppercase; font-size: 12px; transition: 0.3s; pointer-events: all;
            display: flex; align-items: center; gap: 8px;
        }
        .btn-ui:hover { background: white; color: black; transform: scale(1.05); }
        .btn-close { opacity: 0; transform: translateY(-20px); }
        body.reading .btn-close { opacity: 1; transform: translateY(0); }

        .btn-trash {
            width: 45px; height: 45px; padding: 0; background: rgba(255, 50, 50, 0.2); color: #ff6b6b;
            border-radius: 50%; display: none; justify-content: center; align-items: center; border-color: rgba(255, 50, 50, 0.3);
        }
        .btn-trash:hover { background: rgba(255, 50, 50, 0.8); color: white; transform: scale(1.1); }

        .zoom-container {
            background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); padding: 10px 20px; border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 15px; color: white;
        }
        input[type=range] { -webkit-appearance: none; width: 100px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: white; border-radius: 50%; cursor: pointer; }

        .page-counter { font-feature-settings: "tnum"; font-size: 14px; opacity: 0.8; letter-spacing: 1px; }

        /* --- 3D SCENE --- */
        .scene {
            position: relative; width: var(--book-w); height: var(--book-h); transform-style: preserve-3d;
            transition: transform 1.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .scene.closed { transform: rotateX(55deg) rotateZ(-30deg) translateZ(-50px); }
        .scene.open { transform: rotateX(0deg) rotateZ(0deg) translateZ(50px); }

        .book-model {
            width: 100%; height: 100%; position: relative; transform-style: preserve-3d;
            transition: transform 0.1s ease-out, opacity 0.5s; cursor: pointer;
        }
        .book-model.disabled { pointer-events: none; cursor: wait; }
        .scene.open .book-model { opacity: 0; pointer-events: none; }

        /* Layers */
        .layer-back {
            position: absolute; width: 100%; height: 100%; background-color: var(--default-cover);
            transform: translateZ(-2px); box-shadow: 25px 25px 50px rgba(0,0,0,0.5); border-radius: 3px;
            transition: background-color 0.5s;
        }
        .layer-spine {
            position: absolute; top: 0; left: 0; width: var(--depth); height: 100%;
            background-color: var(--spine-color); 
            background-image: linear-gradient(to right, rgba(0,0,0,0.4), transparent 40%, rgba(0,0,0,0.2));
            transform-origin: left; transform: rotateY(-90deg); border-radius: 3px 0 0 3px; transition: background-color 0.5s;
        }
        .layer-pages {
            position: absolute; right: 0; top: 3px; width: calc(var(--book-w) - 5px); height: calc(var(--book-h) - 6px);
            background: #fff; transform: translateZ(calc(var(--depth) / 2));
        }
        .layer-pages::before { content: ''; position: absolute; top:0; left:100%; width:var(--depth); height:100%; background:#e0e0e0; transform-origin:left; transform:rotateY(90deg); background-image:repeating-linear-gradient(to right, #e0e0e0 0, #f5f5f5 1px, #e0e0e0 3px); }
        .layer-pages::after { content: ''; position: absolute; top:100%; left:0; width:100%; height:var(--depth); background:#e0e0e0; transform-origin:top; transform:rotateX(-90deg); background-image:repeating-linear-gradient(to bottom, #e0e0e0 0, #f5f5f5 1px, #e0e0e0 3px); }

        .layer-cover {
            position: absolute; width: 100%; height: 100%; background-color: var(--default-cover);
            background-size: cover; background-position: center; transform: translateZ(var(--depth));
            border-radius: 3px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center; border-left: 2px solid rgba(255,255,255,0.1); transition: background-image 0.5s;
        }
        .cover-text { transition: opacity 0.3s; }
        .layer-cover.has-image .cover-text { opacity: 0; }

        .loader {
            width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white;
            border-radius: 50%; animation: spin 1s infinite linear; margin: 20px auto; display: none;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .reader-stage {
            position: absolute; top:0; left:0; width: calc(var(--book-w) * 2); height: var(--book-h);
            transform: translateX(calc(var(--book-w) / -2)) scale(1); transform-origin: center center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s 0.6s, transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .scene.open .reader-stage { opacity: 1; pointer-events: all; }

        .center-shadow {
            position: absolute; left: 50%; top: 0; width: 60px; height: 100%; transform: translateX(-50%);
            background: linear-gradient(to right, rgba(0,0,0,0) 0%, rgba(0,0,0,0.15) 40%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.15) 60%, rgba(0,0,0,0) 100%);
            z-index: 10; pointer-events: none; mix-blend-mode: multiply;
        }

        .page { background: #fdfdfd; border-right: 1px solid #eee; }
        .page-content { padding: 0; height: 100%; box-sizing: border-box; overflow: hidden; }
        .page-content canvas { width: 100% !important; height: 100% !important; object-fit: contain; }
        .epub-container { padding: 40px; height: 100%; box-sizing: border-box; font-size: 15px; line-height: 1.6; color: #333; text-align: justify; overflow-y: auto; }

        #file-input { display: none; }
        .hint { position: fixed; bottom: 30px; color: rgba(255,255,255,0.3); font-size: 13px; pointer-events: none; transition: opacity 0.5s; }
        .scene.open ~ .hint { opacity: 0; }
    </style>
</head>
<body id="body">

    <div class="click-zone zone-left" onclick="prevPage()" title="Página Anterior"></div>
    <div class="click-zone zone-right" onclick="nextPage()" title="Próxima Página"></div>

    <div class="mood-indicator" id="mood-text">Atmosfera</div>

    <div class="top-controls">
        <div class="btn-ui btn-close" onclick="closeBook()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M15 18l-6-6 6-6"/></svg>
            Fechar
        </div>
        <div class="btn-ui btn-trash" id="btn-trash" onclick="trashBook()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
        </div>
    </div>

    <div class="bottom-controls">
        <div class="zoom-container">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
            <input type="range" id="zoom-slider" min="0.8" max="1.8" step="0.1" value="1" oninput="handleZoom(this.value)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
        </div>
        
        <div class="btn-ui" onclick="toggleAudio()" style="min-width: 40px; justify-content: center;">
            <svg id="icon-sound-on" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
            <svg id="icon-sound-off" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
        </div>

        <div class="zoom-container">
            <span class="page-counter" id="page-counter">-- / --</span>
        </div>
    </div>

    <input type="file" id="file-input" accept=".pdf,.epub">

    <div class="scene closed" id="scene">
        <div class="book-model" id="book-model" onclick="handleInteraction()">
            <div class="layer-back"></div>
            <div class="layer-spine"></div>
            <div class="layer-pages"></div>
            <div class="layer-cover" id="front-cover">
                <div class="layer-cover-overlay" style="position:absolute; width:100%; height:100%; background: linear-gradient(135deg, transparent 30%, rgba(255,255,255,0.2) 50%, transparent 70%); pointer-events:none;"></div>
                <div class="cover-text">
                    <h1 style="margin:0; font-size:2.5rem; letter-spacing: 2px;">LIVRO</h1>
                    <p style="opacity:0.7; margin-top: 10px;">Clique para Abrir</p>
                    <div class="loader" id="loader"></div>
                </div>
            </div>
        </div>
        <div id="reader-anchor"></div> 
    </div>

    <div class="hint">Adicione um livro para ver o ambiente mudar</div>

    <script>
        // Elementos DOM
        const scene = document.getElementById('scene');
        const bookModel = document.getElementById('book-model');
        const fileInput = document.getElementById('file-input');
        const loader = document.getElementById('loader');
        const frontCover = document.getElementById('front-cover');
        const readerAnchor = document.getElementById('reader-anchor');
        const body = document.getElementById('body');
        const btnTrash = document.getElementById('btn-trash');
        const zoomSlider = document.getElementById('zoom-slider');
        const pageCounter = document.getElementById('page-counter');
        const moodText = document.getElementById('mood-text');

        let pageFlip = null;
        let isBookLoaded = false;
        let isReading = false;
        let currentReaderStage = null;
        let isAudioEnabled = true;
        let coverPalette = { c1: '#232526', c2: '#414345', c3: '#121212' };

        // --- ÁUDIO CORRIGIDO ---
        // Base64 curto de ruído branco/papel para garantir que carregue
        // Em um app real, use um arquivo .mp3 hospedado
        const soundBase64 = "data:audio/wav;base64,UklGRi4AAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAACAgEBAQAAAAEBAQEBAQAAAAAAAAAAAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQ=="; 
        
        // Criando o contexto de áudio de forma mais robusta
        const flipAudio = new Audio();
        // Nota: Para um som de papel perfeito, substitua a string abaixo por um link real se preferir
        // Usando um placeholder de "click" curto gerado para evitar erros de string longa
        flipAudio.src = "https://www.soundjay.com/office/sounds/paper-flip-1.mp3"; 
        flipAudio.volume = 0.5;

        // --- MAPA DE EMOÇÕES ---
        const emotionMap = {
            sad: { keywords: ['triste', 'choro', 'lágrimas', 'morte', 'dor', 'solidão', 'escuro', 'luto', 'adeus', 'fim', 'melancolia', 'cinza', 'chuva'], colors: ['#1e3c72', '#2a5298', '#141E30'] },
            happy: { keywords: ['feliz', 'alegria', 'sorriso', 'sol', 'amor', 'luz', 'risada', 'festa', 'vida', 'brilho', 'esperança', 'céu'], colors: ['#F2994A', '#F2C94C', '#ffedbc'] },
            anger: { keywords: ['raiva', 'ódio', 'grito', 'fogo', 'sangue', 'fúria', 'guerra', 'inimigo', 'batalha', 'destruição', 'matar'], colors: ['#cb2d3e', '#ef473a', '#560a0a'] },
            fear: { keywords: ['medo', 'sombra', 'noite', 'terror', 'pânico', 'fantasma', 'monstro', 'escuridão', 'trevas', 'arrepio', 'perigo'], colors: ['#232526', '#414345', '#0f0c29'] },
            calm: { keywords: ['paz', 'rio', 'lago', 'floresta', 'árvore', 'verde', 'vento', 'calma', 'silêncio', 'dormir', 'sonho', 'natureza'], colors: ['#134E5E', '#71B280', '#2d5a3f'] },
            love: { keywords: ['amor', 'beijo', 'paixão', 'coração', 'desejo', 'romance', 'doce', 'flor', 'carinho', 'abraço', 'te amo'], colors: ['#aa076b', '#61045f', '#ff9a9e'] }
        };

        // --- FUNÇÕES DE NAVEGAÇÃO E SOM ---
        function prevPage() { if(pageFlip) pageFlip.flipPrev(); }
        function nextPage() { if(pageFlip) pageFlip.flipNext(); }

        function playFlipSound() {
            if(!isAudioEnabled) return;
            // Reinicia o áudio para tocar rápido em cliques sucessivos
            flipAudio.currentTime = 0;
            flipAudio.play().catch(e => console.log("Áudio bloqueado pelo navegador até interação"));
        }

        function toggleAudio() {
            isAudioEnabled = !isAudioEnabled;
            document.getElementById('icon-sound-on').style.display = isAudioEnabled ? 'block' : 'none';
            document.getElementById('icon-sound-off').style.display = isAudioEnabled ? 'none' : 'block';
        }

        // --- CORES & AMBIENTE ---
        function applyGradient(c1, c2, c3, label) {
            const root = document.documentElement;
            root.style.setProperty('--bg-c1', c1);
            root.style.setProperty('--bg-c2', c2);
            root.style.setProperty('--bg-c3', c3);
            moodText.innerText = label ? `Atmosfera: ${label}` : "";
            moodText.style.color = c2;
        }

        function setAmbientColor(type) {
            let palette;
            let label;
            if (type === 'neutral') {
                palette = [coverPalette.c1, coverPalette.c2, coverPalette.c3];
                label = "Original do Livro";
            } else if (emotionMap[type]) {
                palette = emotionMap[type].colors;
                const labels = { sad: 'Melancolia', happy: 'Alegria', anger: 'Tensão', fear: 'Suspense', calm: 'Serenidade', love: 'Romance' };
                label = labels[type] || type;
            } else return;
            applyGradient(palette[0], palette[1], palette[2], label);
        }

        function analyzeTextAndSetMood(text) {
            if (!text || text.length < 5) return setAmbientColor('neutral');
            const cleanText = text.toLowerCase().substring(0, 500); 
            for (const [emotion, data] of Object.entries(emotionMap)) {
                if (data.keywords.some(word => cleanText.includes(word))) {
                    setAmbientColor(emotion);
                    return;
                }
            }
            setAmbientColor('neutral');
        }

        // --- CORE LOGIC ---
        async function generateCoverAndColor(file) {
            let coverUrl = null;
            if (file.type === 'application/pdf') {
                const buf = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buf).promise;
                const page = await pdf.getPage(1);
                const vp = page.getViewport({ scale: 1.0 });
                const cvs = document.createElement('canvas'); cvs.width = vp.width; cvs.height = vp.height;
                await page.render({ canvasContext: cvs.getContext('2d'), viewport: vp }).promise;
                coverUrl = cvs.toDataURL();
            } else {
                const buf = await file.arrayBuffer();
                const book = ePub(buf);
                coverUrl = await book.coverUrl();
            }

            if (coverUrl) {
                frontCover.style.backgroundImage = `url(${coverUrl})`;
                frontCover.classList.add('has-image');
                extractPalette(coverUrl);
            }
        }

        function extractPalette(src) {
            const img = new Image();
            img.src = src; img.crossOrigin = "Anonymous";
            img.onload = () => {
                const c = document.createElement('canvas'); c.width=50; c.height=50; 
                const ctx = c.getContext('2d'); ctx.drawImage(img,0,0,50,50);
                
                const c1 = getAverageColor(ctx.getImageData(0,0,50,25).data);
                const c2 = getAverageColor(ctx.getImageData(0,25,50,25).data);
                const c3 = { r: Math.max(0, c1.r-40), g: Math.max(0, c1.g-40), b: Math.max(0, c1.b-40) };

                coverPalette = { c1: `rgb(${c1.r},${c1.g},${c1.b})`, c2: `rgb(${c2.r},${c2.g},${c2.b})`, c3: `rgb(${c3.r},${c3.g},${c3.b})` };
                document.documentElement.style.setProperty('--default-cover', coverPalette.c1);
                document.documentElement.style.setProperty('--spine-color', `rgb(${c1.r*0.7},${c1.g*0.7},${c1.b*0.7})`);
                setAmbientColor('neutral');
            }
        }

        function getAverageColor(data) {
            let r=0,g=0,b=0,n=0;
            for(let i=0;i<data.length;i+=4){ r+=data[i];g+=data[i+1];b+=data[i+2];n++; }
            return { r: Math.floor(r/n), g: Math.floor(g/n), b: Math.floor(b/n) };
        }

        function handleZoom(val) {
            if(!currentReaderStage) return;
            currentReaderStage.style.transform = `translateX(${300 / -2}px) scale(${val})`;
        }

        function updatePageData() {
            if(!pageFlip) return;
            const index = pageFlip.getCurrentPageIndex();
            const total = pageFlip.getPageCount();
            pageCounter.innerText = `${index + 1} / ${total}`;

            try {
                const allPages = currentReaderStage.querySelectorAll('.page');
                let combinedText = "";
                const pageEl = allPages[index];
                if (pageEl) combinedText += pageEl.getAttribute('data-text') || pageEl.innerText;
                if (index + 1 < total) {
                    const pageNext = allPages[index + 1];
                    if (pageNext) combinedText += " " + (pageNext.getAttribute('data-text') || pageNext.innerText);
                }
                analyzeTextAndSetMood(combinedText);
            } catch (e) {}
        }

        document.addEventListener('mousemove', (e) => {
            if (isReading) return;
            const xNorm = (e.clientX / window.innerWidth) * 2 - 1;
            const yNorm = (e.clientY / window.innerHeight) * 2 - 1;
            bookModel.style.transform = `rotateX(${yNorm * -15}deg) rotateY(${xNorm * 20}deg)`;
        });

        function handleInteraction() {
            if (bookModel.classList.contains('disabled')) return;
            if (!isBookLoaded) fileInput.click();
            else openBook();
        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            loader.style.display = 'block'; bookModel.classList.add('disabled');
            try {
                await hardReset(); await generateCoverAndColor(file);
                createFreshStage();
                if (file.type === 'application/pdf') await loadPDF(file); else await loadEPUB(file);
                isBookLoaded = true; btnTrash.style.display = 'flex';
                bookModel.style.transform = "scale(1.05)"; setTimeout(() => bookModel.style.transform = "", 300);
            } catch (err) { console.error(err); alert("Erro ao carregar."); trashBook(); 
            } finally { loader.style.display = 'none'; bookModel.classList.remove('disabled'); fileInput.value = ''; }
        });

        async function hardReset() {
            if (pageFlip) { pageFlip.destroy(); pageFlip = null; }
            if (currentReaderStage) { currentReaderStage.remove(); currentReaderStage = null; }
            frontCover.style.backgroundImage = 'none'; frontCover.classList.remove('has-image');
            coverPalette = { c1: '#232526', c2: '#414345', c3: '#121212' };
            setAmbientColor('neutral'); isBookLoaded = false; zoomSlider.value = 1;
        }

        function createFreshStage() {
            const div = document.createElement('div'); div.className = 'reader-stage';
            const shadow = document.createElement('div'); shadow.className = 'center-shadow';
            div.appendChild(shadow); readerAnchor.appendChild(div); currentReaderStage = div;
        }

        function trashBook() { closeBook(); setTimeout(() => { hardReset(); btnTrash.style.display = 'none'; }, 600); }

        function openBook() {
            isReading = true;
            bookModel.style.transform = 'rotateX(0deg) rotateY(0deg)';
            scene.classList.remove('closed'); scene.classList.add('open');
            body.classList.add('reading');
            // Tenta desbloquear o áudio no clique de abrir
            flipAudio.play().then(() => flipAudio.pause()).catch(() => {});
            setTimeout(() => { if (!pageFlip) initFlip(); }, 600);
        }

        function closeBook() {
            isReading = false;
            scene.classList.remove('open'); scene.classList.add('closed');
            body.classList.remove('reading');
            setTimeout(() => { zoomSlider.value = 1; handleZoom(1); setAmbientColor('neutral'); }, 500);
        }

        function initFlip() {
            if(!currentReaderStage) return;
            const pages = currentReaderStage.querySelectorAll('.page');
            pageFlip = new St.PageFlip(currentReaderStage, {
                width: 300, height: 440, size: 'fixed', minWidth: 300, maxWidth: 300, minHeight: 440, maxHeight: 440,
                showCover: false, usePortrait: false, maxShadowOpacity: 0.5, autoSize: true, flippingTime: 800
            });
            pageFlip.loadFromHTML(pages);
            pageFlip.on('flip', (e) => { playFlipSound(); updatePageData(); });
            updatePageData();
        }

        async function loadPDF(file) {
            const buf = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(buf).promise;
            const maxPages = Math.min(pdf.numPages, 40); 
            for(let i=1; i<=maxPages; i++){
                const p = await pdf.getPage(i);
                let pageText = ""; try { pageText = (await p.getTextContent()).items.slice(0, 40).map(i=>i.str).join(' '); } catch(e){}
                const vpRaw = p.getViewport({scale:1});
                const scale = (440 / vpRaw.height) * 2; 
                const vp = p.getViewport({scale: scale});
                const d = document.createElement('div'); d.className = 'page'; d.setAttribute('data-text', pageText);
                d.innerHTML = `<div class="page-content"><canvas></canvas></div>`;
                const canvas = d.querySelector('canvas'); canvas.width = vp.width; canvas.height = vp.height;
                await p.render({canvasContext: canvas.getContext('2d'), viewport: vp}).promise;
                currentReaderStage.appendChild(d); 
            }
        }

        async function loadEPUB(file) {
            const buf = await file.arrayBuffer(); const book = ePub(buf); await book.ready;
            const spine = book.spine; let count = 0;
            for(const item of spine.items){
                if(count > 40) break; 
                const section = await book.load(item.href);
                let contentHTML = "";
                if (section instanceof Document) contentHTML = section.body.innerHTML;
                else if (section instanceof DocumentFragment) { const div = document.createElement('div'); div.appendChild(section.cloneNode(true)); contentHTML = div.innerHTML; }
                else contentHTML = `<p>${section.innerText || ""}</p>`;
                const d = document.createElement('div'); d.className = 'page';
                d.innerHTML = `<div class="epub-container">${contentHTML}</div>`;
                d.querySelectorAll('img').forEach(img => { img.style.maxWidth = '100%'; img.style.height = 'auto'; });
                currentReaderStage.appendChild(d); count++;
            }
        }

        window.addEventListener('keydown', (e) => {
            if(!isReading || !pageFlip) return;
            if(e.key==="ArrowRight") nextPage();
            if(e.key==="ArrowLeft") prevPage();
            if(e.key==="Escape") closeBook();
        });
    </script>
</body>
</html>